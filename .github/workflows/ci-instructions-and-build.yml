name: CI - Copilot instructions & build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  actions: write

jobs:
  guard-instructions:
    name: Guard Copilot instructions (non-blocking)
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Validate instructions (token-based, debug)
        shell: bash
        run: |
          set -euo pipefail
          test -f .github/copilot-instructions.md
          test -s .github/copilot-instructions.md || echo "::warning::instructions file is empty"
          echo "First line (debug):"
          head -n1 .github/copilot-instructions.md | cat -A
          first="$(head -n1 .github/copilot-instructions.md)"
          case "$first" in \#*) ;; *) echo "::warning::Header should start with '#' on line 1";; esac
          grep -q "Copilot" <<<"$first" || echo "::warning::First line should contain 'Copilot'"
          grep -q "sbe_latency_bot" <<<"$first" || echo "::warning::First line should contain 'sbe_latency_bot'"
          for t in "[BOOT]" "[HARAM]" "[SHADOW]" "[BUY]" "[SELL]"; do
            if ! grep -qF "$t" .github/copilot-instructions.md; then
              echo "::warning::Missing tag in instructions: $t"
            fi
          done

  build:
    name: Build release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      - name: Prepare logs dir
        run: |
          mkdir -p logs
          echo "Runner info:" > logs/env.txt
          uname -a >> logs/env.txt
          rustc -Vv || true >> logs/env.txt
          cargo -V  || true >> logs/env.txt

      - name: System deps
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config libssl-dev clang protobuf-compiler openjdk-17-jdk

      - name: Fetch SBE tool
        run: |
          mkdir -p .tools
          curl -sSL -o .tools/sbe-all.jar https://repo1.maven.org/maven2/uk/co/real-logic/sbe-all/1.31.0/sbe-all-1.31.0.jar
      - name: Sync schema inputs
        run: |
          set -euo pipefail
          mkdir -p native/schemas
          cp schemas/binance_sbe.xml native/schemas/spot_sbe.xml
          cp schemas/binance_stream_sbe.xml native/schemas/stream_1_0.xml
      - name: Generate SBE headers (C++)
        run: |
          set -euxo pipefail
          mkdir -p native/include
          java -Dsbe.target.language=CPP \
               -Dsbe.output.dir=native/include \
               -Dsbe.target.namespace=spot_stream \
               -jar .tools/sbe-all.jar native/schemas/spot_sbe.xml
          java -Dsbe.target.language=CPP \
               -Dsbe.output.dir=native/include \
               -Dsbe.target.namespace=spot_stream \
               -jar .tools/sbe-all.jar native/schemas/stream_1_0.xml
          echo "---- headers tree (first 200 lines) ----"
          ls -R native/include | sed -n '1,200p'
          test -f native/include/spot_stream/MessageHeader.h
          test -f native/include/spot_stream/TradesStreamEvent.h

      - name: Build release (shadow-mode)
        run: |
          set -o pipefail
          cargo build --release |& tee logs/build.log

      - name: Append build tail to Step Summary
        if: always()
        run: |
          echo '### Build tail (last 200 lines)' >> $GITHUB_STEP_SUMMARY
          (tail -n 200 logs/build.log || true) >> $GITHUB_STEP_SUMMARY

      - name: Upload CI logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-logs
          path: logs/*
          if-no-files-found: warn
          retention-days: 7
