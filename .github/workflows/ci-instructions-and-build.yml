name: CI - Copilot instructions & build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  actions: write

env:
  # Pin to a specific ref; resolve to a commit once per run for stability
  BINANCE_SPOT_REF: refs/heads/master

jobs:
  guard-instructions:
    name: Guard Copilot instructions (non-blocking)
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Validate instructions (token-based, debug)
        shell: bash
        run: |
          set -euo pipefail
          test -f .github/copilot-instructions.md
          test -s .github/copilot-instructions.md || echo "::warning::instructions file is empty"
          echo "First line (debug):"
          head -n1 .github/copilot-instructions.md | cat -A
          first="$(head -n1 .github/copilot-instructions.md)"
          case "$first" in \#*) ;; *) echo "::warning::Header should start with '#' on line 1";; esac
          grep -q "Copilot" <<<"$first" || echo "::warning::First line should contain 'Copilot'"
          grep -q "sbe_latency_bot" <<<"$first" || echo "::warning::First line should contain 'sbe_latency_bot'"
          for t in "[BOOT]" "[HARAM]" "[SHADOW]" "[BUY]" "[SELL]"; do
            if ! grep -qF "$t" .github/copilot-instructions.md; then
              echo "::warning::Missing tag in instructions: $t"
            fi
          done

  build:
    name: Build release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: cargo-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Prepare logs dir
        run: |
          mkdir -p logs
          echo "Runner info:" > logs/env.txt
          uname -a >> logs/env.txt
          rustc -Vv || true >> logs/env.txt
          cargo -V  || true >> logs/env.txt

      - name: System deps
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config libssl-dev clang protobuf-compiler openjdk-17-jdk

      - name: Fetch SBE tool
        run: |
          mkdir -p .tools
          curl -sSL -o .tools/sbe-all.jar https://repo1.maven.org/maven2/uk/co/real-logic/sbe-all/1.31.0/sbe-all-1.31.0.jar
      - name: Resolve binance-spot-api-docs commit (pin)
        id: pin
        run: |
          set -euxo pipefail
          REF="${BINANCE_SPOT_REF}"
          SHA="$(git ls-remote https://github.com/binance/binance-spot-api-docs "$REF" | awk '{print $1}')"
          echo "sha=$SHA" >> "$GITHUB_OUTPUT"
          echo "Resolved $REF -> $SHA"
      - name: Fetch Binance Spot SBE schemas (pinned)
        run: |
          set -euxo pipefail
          mkdir -p native/schemas
          curl -fsSL -o native/schemas/spot_sbe.xml   "https://raw.githubusercontent.com/binance/binance-spot-api-docs/${{ steps.pin.outputs.sha }}/sbe/schemas/spot_3_1.xml"
          curl -fsSL -o native/schemas/stream_1_0.xml "https://raw.githubusercontent.com/binance/binance-spot-api-docs/${{ steps.pin.outputs.sha }}/sbe/schemas/stream_1_0.xml"
          ls -l native/schemas
      - name: Generate SBE headers (C++)
        run: |
          set -euxo pipefail
          mkdir -p native/include
          java -Dsbe.target.language=CPP \
               -Dsbe.output.dir=native/include \
               -Dsbe.target.namespace=spot_stream \
               -jar .tools/sbe-all.jar native/schemas/spot_sbe.xml
          java -Dsbe.target.language=CPP \
               -Dsbe.output.dir=native/include \
               -Dsbe.target.namespace=spot_stream \
               -jar .tools/sbe-all.jar native/schemas/stream_1_0.xml
          echo "---- headers tree (first 200 lines) ----"
          ls -R native/include | sed -n '1,200p'
          test -f native/include/spot_stream/MessageHeader.h
          test -f native/include/spot_stream/TradesStreamEvent.h

      - name: Build release (shadow-mode)
        run: |
          set -o pipefail
          cargo build --release --bin sbe_latency_bot |& tee logs/build.log

      - name: List release outputs
        run: |
          set -euxo pipefail
          ls -l target/release || true
          test -f target/release/sbe_latency_bot || (echo "binary missing at target/release/sbe_latency_bot" >&2; exit 2)
          file target/release/sbe_latency_bot || true

      - name: Verify native symbol (bsbe_try_decode_one)
        run: |
          set -euxo pipefail
          LIB="$(find target/release/build -type f -path '*/out/lib/libbsbe_native.a' | head -n1)"
          if command -v llvm-nm >/dev/null 2>&1; then TOOL=llvm-nm; else TOOL=nm; fi
          "$TOOL" -g "$LIB" | grep -E '\bbsbe_try_decode_one\b'

      - name: Append build tail to Step Summary
        if: always()
        run: |
          echo '### Build tail (last 200 lines)' >> $GITHUB_STEP_SUMMARY
          (tail -n 200 logs/build.log || true) >> $GITHUB_STEP_SUMMARY

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: sbe_latency_bot-linux-x86_64
          path: target/release/sbe_latency_bot
          if-no-files-found: error

      - name: Upload CI logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-logs
          path: logs/*
          if-no-files-found: warn
          retention-days: 7
