
name: CI – Copilot instructions & build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  guard-instructions:
    name: Guard Copilot instructions
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure Copilot instructions exist
        run: test -f .github/copilot-instructions.md

      - name: Validate header & required log tags in instructions (token-based, debug)
        shell: bash
        run: |
          set -euo pipefail
          echo "First line (debug):"
          head -n1 .github/copilot-instructions.md | cat -A
          echo "MIME (debug):"
          file -bi .github/copilot-instructions.md

          first="$(head -n1 .github/copilot-instructions.md)"

          # لازم يبدأ بعلامة عنوان #
          case "$first" in
            \#*) ;; 
            *) echo "Header must start with '#' on line 1"; exit 1;;
          esac

          # توكِنز مطلوبة في السطر الأول (نتجنّب مشاكل الشرطة/التطبيع)
          grep -q "Copilot" <<<"$first"
          grep -q "sbe_latency_bot" <<<"$first"

          # الوسوم الخمسة لازم تكون موجودة في نفس الملف
          grep -q "\[BOOT\]"   .github/copilot-instructions.md
          grep -q "\[HARAM\]"  .github/copilot-instructions.md
          grep -q "\[SHADOW\]" .github/copilot-instructions.md
          grep -q "\[BUY\]"    .github/copilot-instructions.md
          grep -q "\[SELL\]"   .github/copilot-instructions.md

      - name: Warn if schemas changed (clean build recommended)
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
          else
            BASE_SHA="$(git rev-parse HEAD~1 || echo '')"
          fi
          if [[ -n "$BASE_SHA" ]]; then
            if git diff --name-only "$BASE_SHA"...HEAD | grep -q -E '^schemas/.*\.xml$'; then
              echo "::warning::schemas/*.xml changed. Run a clean build locally: 'cargo clean && cargo build --release'."
            fi
          fi

      - name: Validate tags exist in source tree (advisory)
        shell: bash
        run: |
          for t in "[BOOT]" "[HARAM]" "[SHADOW]" "[BUY]" "[SELL]"; do
            if ! grep -R -n -F "$t" --include="*.rs" src >/dev/null 2>&1; then
              echo "::warning::No $t occurrences found under src (OK if intentionally refactored)."
            fi
          done

  build:
    name: Build (shadow-mode)
    runs-on: ubuntu-latest
    needs: guard-instructions
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install native toolchain (cmake, gcc, deps)
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential cmake pkg-config libssl-dev \
            clang llvm-dev libclang-dev ninja-build
      - name: Build release (shadow-mode)
        run: cargo build --release --features shadow-mode
