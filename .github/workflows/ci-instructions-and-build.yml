name: CI - Copilot instructions & build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  guard-instructions:
    name: Guard Copilot instructions (non-blocking)
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Validate instructions (token-based, debug)
        shell: bash
        run: |
          set -euo pipefail
          test -f .github/copilot-instructions.md
          test -s .github/copilot-instructions.md || echo "::warning::instructions file is empty"
          echo "First line (debug):"
          head -n1 .github/copilot-instructions.md | cat -A
          first="$(head -n1 .github/copilot-instructions.md)"
          case "$first" in \#*) ;; *) echo "::warning::Header should start with '#' on line 1";; esac
          grep -q "Copilot" <<<"$first" || echo "::warning::First line should contain 'Copilot'"
          grep -q "sbe_latency_bot" <<<"$first" || echo "::warning::First line should contain 'sbe_latency_bot'"
          for t in "[BOOT]" "[HARAM]" "[SHADOW]" "[BUY]" "[SELL]"; do
            if ! grep -qF "$t" .github/copilot-instructions.md; then
              echo "::warning::Missing tag in instructions: $t"
            fi
          done

  build:
    name: Build (shadow-mode)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      - name: Install native toolchain (cmake, gcc, deps)
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential cmake pkg-config libssl-dev \
            clang llvm-dev libclang-dev ninja-build zlib1g-dev

      - name: Build release (shadow-mode)
        run: |
          set -o pipefail
          cargo build --release --features shadow-mode 2>&1 | tee build.log

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build.log